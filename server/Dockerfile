# Base image
FROM node:18

ARG DATABASE_URL_ARG
ENV DATABASE_URL=$DATABASE_URL_ARG

ARG DATABASE_USER_ARG
ENV DATABASE_USER=$DATABASE_USER_ARG

ARG DATABASE_PASSWORD_ARG
ENV DATABASE_PASSWORD=$DATABASE_PASSWORD_ARG

ARG NCP_secretKey_ARG
ENV NCP_secretKey=$NCP_secretKey_ARG

ARG NCP_accessKey_ARG
ENV NCP_accessKey=$NCP_accessKey_ARG

ARG hostPhoneNumber_ARG
ENV hostPhoneNumber=$hostPhoneNumber_ARG

ARG NCP_SMS_URL_ARG
ENV NCP_SMS_URL=$NCP_SMS_URL

ARG NCP_DEVICE_TOKEN_REGISTRATION_URL_ARG
ENV NCP_DEVICE_TOKEN_REGISTRATION_URL=$NCP_DEVICE_TOKEN_REGISTRATION_URL_ARG

ARG SECRET_ARG
ENV secret=$SECRET_ARG

ARG NCP_SMS_SERVICEID_ARG
ENV NCP_SMS_SERVICEID=$NCP_SMS_SERVICEID_ARG

ARG NCP_NOTIFICATION_SERVICEID_ARG
ENV NCP_NOTIFICATION_SERVICEID=$NCP_NOTIFICATION_SERVICEID_ARG

ARG AWS_REGION_ARG
ENV AWS_REGION=$AWS_REGION_ARG

ARG AWS_ACCESS_KEY_ARG
ENV AWS_ACCESS_KEY=$AWS_ACCESS_KEY_ARG

ARG AWS_SECRET_KEY_ARG
ENV AWS_SECRET_KEY=$AWS_SECRET_KEY_ARG

ARG AWS_BUCKET_NAME_ARG
ENV AWS_BUCKET_NAME=$AWS_BUCKET_NAME_ARG

ARG ML_SERVER_HOST_ARG
ENV ML_SERVER_HOST=$ML_SERVER_HOST_ARG

ARG NCP_AI_CLIENT_ID_ARG
ENV NCP_AI_CLIENT_ID=$NCP_AI_CLIENT_ID_ARG

ARG NCP_AI_SECRET_KEY_ARG
ENV NCP_AI_SECRET_KEY=$NCP_AI_SECRET_KEY_ARG

ARG REDIS_HOST_ARG
ENV REDIS_HOST=$REDIS_HOST_ARG

ARG REDIS_PASSWORD_ARG
ENV REDIS_PASSWORD=$REDIS_PASSWORD_ARG

ARG REDIS_PORT_ARG
ENV REDIS_PORT=$REDIS_PORT_ARG

ARG REDIS_USER_ARG
ENV REDIS_USER=$REDIS_USER_ARG

ENV TZ=Asia/Seoul

# Bundle APP files
WORKDIR /emerdy-server

COPY . .

RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
RUN npm cache clean --force
RUN npm install -g pm2
RUN npm install -g dotenv-cli

# Install app dependencies
RUN npm install --include=dev

# Creates a "dist" folder with the production build
RUN npm run build

# Expose the listening port of your app
EXPOSE 3000
EXPOSE 3030

# Start the server using the production build
#CMD ["pm2-runtime", "start", "ecosystem.config.js", "--env", ${NODE_ENV_ARG}]
CMD ["sh", "-c", "pm2-runtime start ecosystem.config.js --env production"]